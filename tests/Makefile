include Makefile_test.in
include ../Makefile.in

# A sample Makefile for building Google Test and using it in user
# tests.  Please tweak it to suit your environment and project.  You
# may want to move it to your project's root directory.
#
# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make clean  - removes all files generated by make.

# House-keeping build targets.

all :
	@$(MAKE) gtest-all.o
	@$(MAKE) gtest_main.o
	@$(MAKE) gtest.a
	@$(MAKE) gtest_main.a	
	@$(MAKE) "FLAGS = $(COVFLAGS)" "LDFLAGS += -lgcov -coverage" library_test
	@$(MAKE) run_tests	

library_test :
	$(MAKE) -C src/
	
run_tests :
	@echo \*************************************
	@echo \*************************************	
	@echo          Running unit tests
	@echo \*************************************
	@echo \*************************************
	$(eval export GCOV_PREFIX=$(OBJDIR))
	$(eval export GCOV_PREFIX_STRIP=$(NUMBER_OF_SLASHES))
	@$(TSTBINDIR)/R2P_test
	@$(MAKE) generate_coverage
	
generate_coverage :
	@echo Generating test coverage...
	@cd $(OBJDIR) && $(GCOVR) --gcov-executable=$(GCOV) \
	--html --html-details --html-absolute-paths \
	-o $(COVERAGE)/R2P_test.html -r $(SRCDIR) .

.PHONY: clean
clean:
	rm -f $(TSTLIBDIR)/gtest.a $(TSTLIBDIR)/gtest_main.a
	rm -f $(OBJDIR)/gtest-all.o $(OBJDIR)/gtest_main.o
	$(MAKE) clean -C $(TSTSRCDIR)
	cd $(COVERAGE); rm -f *.html
	
# Builds gtest.a and gtest_main.a.

# For simplicity and to avoid depending on Google Test's
# implementation details, the dependencies specified below are
# conservative and not optimized.  This is fine as Google Test
# compiles fast and for ordinary users its source rarely changes.
gtest-all.o : $(GTEST_SRCS_)
	$(CXX) $(CPPFLAGS) -I$(GTEST_DIR) -I$(GTEST_DIR)/include $(CXXFLAGS) -c \
            $(GTEST_DIR)/src/gtest-all.cc -o $(OBJDIR)/$@

gtest_main.o : $(GTEST_SRCS_)
	$(CXX) $(CPPFLAGS) -I$(GTEST_DIR) -I$(GTEST_DIR)/include $(CXXFLAGS) -c \
            $(GTEST_DIR)/src/gtest_main.cc -o $(OBJDIR)/$@

gtest.a : gtest-all.o
	$(AR) $(TSTLIBDIR)/$@ $^

gtest_main.a : gtest-all.o gtest_main.o
	$(AR) $(TSTLIBDIR)/$@ $^
